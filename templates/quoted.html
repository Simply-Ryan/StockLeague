{% extends "layout.html" %}

{% block title %}{{ quote.symbol }} - Stock Quote{% endblock %}

{% block main %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow">
            <div class="card-body">
                <!-- Header with company name and symbol -->
                <div class="text-center mb-4">
                    <h2 class="mb-2">{{ quote.name }}</h2>
                    <h3 class="text-primary mb-0">{{ quote.symbol }}</h3>
                </div>

                <!-- Current Price and Change -->
                <div class="row mb-4">
                    <div class="col-md-6 text-center">
                        <h6 class="text-muted">Current Price</h6>
                        <div class="display-4 text-success stock-price" data-symbol="{{ quote.symbol }}">
                            {{ quote.price | usd }}
                        </div>
                        <small class="text-muted"><i class="fas fa-circle text-success"></i> Live</small>
                    </div>
                    <div class="col-md-6 text-center">
                        <h6 class="text-muted">Change</h6>
                        <div class="display-6 stock-change {% if quote.change >= 0 %}text-success{% else %}text-danger{% endif %}" data-symbol="{{ quote.symbol }}">
                            {% if quote.change >= 0 %}+{% endif %}{{ quote.change | usd }}
                            <small>({% if quote.change_percent >= 0 %}+{% endif %}{{ "%.2f" | format(quote.change_percent) }}%)</small>
                        </div>
                    </div>
                </div>

                <!-- Stock Details Grid -->
                <div class="row mb-4">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Open</h6>
                                <p class="card-text fw-bold">{{ quote.open | usd }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Previous Close</h6>
                                <p class="card-text fw-bold">{{ quote.previous_close | usd }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Day High</h6>
                                <p class="card-text fw-bold text-success">{{ quote.high | usd }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Day Low</h6>
                                <p class="card-text fw-bold text-danger">{{ quote.low | usd }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Price Chart -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Price Chart</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-timeframe="D" data-days="30">1M</button>
                            <button type="button" class="btn btn-outline-primary" data-timeframe="D" data-days="90">3M</button>
                            <button type="button" class="btn btn-outline-primary" data-timeframe="D" data-days="180">6M</button>
                            <button type="button" class="btn btn-outline-primary" data-timeframe="D" data-days="365">1Y</button>
                        </div>
                    </div>
                    
                    <!-- Indicator Toggles -->
                    <div class="mb-3">
                        <div class="btn-group btn-group-sm flex-wrap" role="group">
                            <input type="checkbox" class="btn-check" id="indicator-sma20" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="indicator-sma20">SMA 20</label>
                            
                            <input type="checkbox" class="btn-check" id="indicator-sma50" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="indicator-sma50">SMA 50</label>
                            
                            <input type="checkbox" class="btn-check" id="indicator-ema20" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="indicator-ema20">EMA 20</label>
                            
                            <input type="checkbox" class="btn-check" id="indicator-bb" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="indicator-bb">Bollinger Bands</label>
                            
                            <input type="checkbox" class="btn-check" id="indicator-rsi" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="indicator-rsi">RSI</label>
                            
                            <input type="checkbox" class="btn-check" id="indicator-macd" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="indicator-macd">MACD</label>
                        </div>
                    </div>
                    
                    <!-- Main Chart Container -->
                    <div id="mainChart" style="height: 500px; background-color: var(--card-bg); border-radius: 8px; position: relative;">
                        <div class="text-center" style="padding-top: 200px;">
                            <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
                            <p class="mt-3">Loading chart data...</p>
                        </div>
                    </div>
                    
                    <!-- Volume Chart -->
                    <div id="volumeChart" style="height: 100px; background-color: var(--card-bg); border-radius: 8px; margin-top: 10px;"></div>
                    
                    <!-- RSI Chart (hidden by default) -->
                    <div id="rsiChart" style="height: 150px; background-color: var(--card-bg); border-radius: 8px; margin-top: 10px; display: none;"></div>
                    
                    <!-- MACD Chart (hidden by default) -->
                    <div id="macdChart" style="height: 150px; background-color: var(--card-bg); border-radius: 8px; margin-top: 10px; display: none;"></div>
                </div>

                <!-- Action Buttons -->
                <hr>
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <a href="/quote" class="btn btn-primary">
                        <i class="fas fa-search"></i> Get Another Quote
                    </a>
                    <a href="/buy?symbol={{ quote.symbol }}" class="btn btn-success">
                        <i class="fas fa-shopping-cart"></i> Buy {{ quote.symbol }}
                    </a>
                    {% if in_watchlist %}
                    <form action="/watchlist/remove" method="post" class="d-inline">
                        <input type="hidden" name="symbol" value="{{ quote.symbol }}">
                        <button type="submit" class="btn btn-outline-warning">
                            <i class="fas fa-star"></i> Remove from Watchlist
                        </button>
                    </form>
                    {% else %}
                    <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#addWatchlistModal">
                        <i class="far fa-star"></i> Add to Watchlist
                    </button>
                    {% endif %}
                    <a href="/" class="btn btn-secondary">
                        <i class="fas fa-home"></i> Back to Portfolio
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent News -->
    {% if news %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-newspaper"></i> Recent News</h5>
        </div>
        <div class="card-body">
            {% for article in news %}
            <div class="mb-3 {% if not loop.last %}pb-3 border-bottom{% endif %}">
                <h6 class="mb-1">
                    <a href="{{ article.url }}" target="_blank" class="text-decoration-none">
                        {{ article.headline }}
                    </a>
                </h6>
                <small class="text-muted">
                    {{ article.source }}
                </small>
                {% if article.summary %}
                <p class="mb-0 mt-1 small text-muted">{{ article.summary[:200] }}{% if article.summary|length > 200 %}...{% endif %}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- TradingView Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<script>
    // Chart configuration
    let mainChart, candlestickSeries, volumeSeries, rsiSeries, macdSeries;
    let sma20Series, sma50Series, ema20Series, bbUpperSeries, bbMiddleSeries, bbLowerSeries;
    let macdLineSeries, macdSignalSeries, macdHistogramSeries;
    let currentTimeframe = 'D';
    let currentDays = 30;
    let chartData = null;
    
    // Initialize charts
    function initCharts() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const chartOptions = {
            layout: {
                background: { color: 'transparent' },
                textColor: isDark ? '#e2e8f0' : '#334155',
            },
            grid: {
                vertLines: { color: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.2)' },
                horzLines: { color: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.2)' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: isDark ? 'rgba(148, 163, 184, 0.3)' : 'rgba(148, 163, 184, 0.5)',
            },
            timeScale: {
                borderColor: isDark ? 'rgba(148, 163, 184, 0.3)' : 'rgba(148, 163, 184, 0.5)',
                timeVisible: true,
                secondsVisible: false,
            },
        };
        
        // Main chart (candlesticks)
        mainChart = LightweightCharts.createChart(document.getElementById('mainChart'), {
            ...chartOptions,
            height: 500,
        });
        
        candlestickSeries = mainChart.addCandlestickSeries({
            upColor: '#10b981',
            downColor: '#ef4444',
            borderUpColor: '#10b981',
            borderDownColor: '#ef4444',
            wickUpColor: '#10b981',
            wickDownColor: '#ef4444',
        });
        
        // Volume chart
        const volumeChart = LightweightCharts.createChart(document.getElementById('volumeChart'), {
            ...chartOptions,
            height: 100,
        });
        
        volumeSeries = volumeChart.addHistogramSeries({
            color: '#6366f1',
            priceFormat: {
                type: 'volume',
            },
        });
        
        // Sync crosshair between charts
        mainChart.timeScale().subscribeVisibleTimeRangeChange(() => {
            const timeRange = mainChart.timeScale().getVisibleRange();
            if (timeRange) {
                volumeChart.timeScale().setVisibleRange(timeRange);
            }
        });
    }
    
    // Load chart data
    async function loadChartData() {
        try {
            const response = await fetch(`/api/chart/{{ quote.symbol }}?timeframe=${currentTimeframe}&days=${currentDays}`);
            const data = await response.json();
            
            if (data.error) {
                console.error('Error loading chart:', data.error);
                return;
            }
            
            chartData = data;
            updateChartData();
        } catch (error) {
            console.error('Error fetching chart data:', error);
        }
    }
    
    // Update chart with data
    function updateChartData() {
        if (!chartData || !candlestickSeries) return;
        
        // Set candlestick data
        candlestickSeries.setData(chartData.candles);
        
        // Set volume data
        const volumeData = chartData.candles.map(c => ({
            time: c.time,
            value: c.volume,
            color: c.close >= c.open ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)'
        }));
        volumeSeries.setData(volumeData);
        
        // Auto-fit charts
        mainChart.timeScale().fitContent();
    }
    
    // Toggle indicators
    function toggleIndicator(indicator) {
        const checkbox = document.getElementById(`indicator-${indicator}`);
        
        switch(indicator) {
            case 'sma20':
                if (checkbox.checked) {
                    if (!sma20Series) {
                        sma20Series = mainChart.addLineSeries({
                            color: '#f59e0b',
                            lineWidth: 2,
                            title: 'SMA 20',
                        });
                    }
                    sma20Series.setData(chartData.sma_20);
                } else if (sma20Series) {
                    mainChart.removeSeries(sma20Series);
                    sma20Series = null;
                }
                break;
                
            case 'sma50':
                if (checkbox.checked) {
                    if (!sma50Series) {
                        sma50Series = mainChart.addLineSeries({
                            color: '#8b5cf6',
                            lineWidth: 2,
                            title: 'SMA 50',
                        });
                    }
                    sma50Series.setData(chartData.sma_50);
                } else if (sma50Series) {
                    mainChart.removeSeries(sma50Series);
                    sma50Series = null;
                }
                break;
                
            case 'ema20':
                if (checkbox.checked) {
                    if (!ema20Series) {
                        ema20Series = mainChart.addLineSeries({
                            color: '#06b6d4',
                            lineWidth: 2,
                            title: 'EMA 20',
                            lineStyle: 2, // Dashed
                        });
                    }
                    ema20Series.setData(chartData.ema_20);
                } else if (ema20Series) {
                    mainChart.removeSeries(ema20Series);
                    ema20Series = null;
                }
                break;
                
            case 'bb':
                if (checkbox.checked) {
                    if (!bbUpperSeries) {
                        bbUpperSeries = mainChart.addLineSeries({
                            color: '#ec4899',
                            lineWidth: 1,
                            title: 'BB Upper',
                        });
                        bbMiddleSeries = mainChart.addLineSeries({
                            color: '#ec4899',
                            lineWidth: 1,
                            title: 'BB Middle',
                            lineStyle: 2,
                        });
                        bbLowerSeries = mainChart.addLineSeries({
                            color: '#ec4899',
                            lineWidth: 1,
                            title: 'BB Lower',
                        });
                    }
                    bbUpperSeries.setData(chartData.bollinger.upper);
                    bbMiddleSeries.setData(chartData.bollinger.middle);
                    bbLowerSeries.setData(chartData.bollinger.lower);
                } else {
                    if (bbUpperSeries) {
                        mainChart.removeSeries(bbUpperSeries);
                        mainChart.removeSeries(bbMiddleSeries);
                        mainChart.removeSeries(bbLowerSeries);
                        bbUpperSeries = null;
                        bbMiddleSeries = null;
                        bbLowerSeries = null;
                    }
                }
                break;
                
            case 'rsi':
                const rsiDiv = document.getElementById('rsiChart');
                if (checkbox.checked) {
                    rsiDiv.style.display = 'block';
                    if (!rsiSeries) {
                        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                        const rsiChart = LightweightCharts.createChart(rsiDiv, {
                            height: 150,
                            layout: {
                                background: { color: 'transparent' },
                                textColor: isDark ? '#e2e8f0' : '#334155',
                            },
                            grid: {
                                vertLines: { color: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.2)' },
                                horzLines: { color: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.2)' },
                            },
                            rightPriceScale: {
                                scaleMargins: { top: 0.1, bottom: 0.1 },
                            },
                        });
                        rsiSeries = rsiChart.addLineSeries({
                            color: '#f59e0b',
                            lineWidth: 2,
                        });
                        rsiSeries.setData(chartData.rsi);
                        
                        // Sync with main chart
                        mainChart.timeScale().subscribeVisibleTimeRangeChange(() => {
                            const timeRange = mainChart.timeScale().getVisibleRange();
                            if (timeRange) rsiChart.timeScale().setVisibleRange(timeRange);
                        });
                    }
                } else {
                    rsiDiv.style.display = 'none';
                    rsiSeries = null;
                }
                break;
                
            case 'macd':
                const macdDiv = document.getElementById('macdChart');
                if (checkbox.checked) {
                    macdDiv.style.display = 'block';
                    if (!macdSeries) {
                        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                        const macdChart = LightweightCharts.createChart(macdDiv, {
                            height: 150,
                            layout: {
                                background: { color: 'transparent' },
                                textColor: isDark ? '#e2e8f0' : '#334155',
                            },
                            grid: {
                                vertLines: { color: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.2)' },
                                horzLines: { color: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.2)' },
                            },
                        });
                        
                        macdHistogramSeries = macdChart.addHistogramSeries({
                            color: '#6366f1',
                        });
                        macdLineSeries = macdChart.addLineSeries({
                            color: '#10b981',
                            lineWidth: 2,
                        });
                        macdSignalSeries = macdChart.addLineSeries({
                            color: '#ef4444',
                            lineWidth: 2,
                        });
                        
                        macdHistogramSeries.setData(chartData.macd.histogram);
                        macdLineSeries.setData(chartData.macd.macd);
                        macdSignalSeries.setData(chartData.macd.signal);
                        
                        // Sync with main chart
                        mainChart.timeScale().subscribeVisibleTimeRangeChange(() => {
                            const timeRange = mainChart.timeScale().getVisibleRange();
                            if (timeRange) macdChart.timeScale().setVisibleRange(timeRange);
                        });
                    }
                } else {
                    macdDiv.style.display = 'none';
                    macdSeries = null;
                }
                break;
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        loadChartData();
        
        // Timeframe buttons
        document.querySelectorAll('[data-timeframe]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-timeframe]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTimeframe = this.dataset.timeframe;
                currentDays = parseInt(this.dataset.days);
                loadChartData();
            });
        });
        
        // Indicator toggles
        document.querySelectorAll('[id^="indicator-"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const indicator = this.id.replace('indicator-', '');
                toggleIndicator(indicator);
            });
        });
    });
</script>

<script>
    // Override stock price update for quoted page to handle display-4 formatting
    const originalUpdateStockPrice = window.updateStockPrice;
    window.updateStockPrice = function(data) {
        if (data.symbol === '{{ quote.symbol }}') {
            // Update price with $ sign
            const priceEl = document.querySelector('.stock-price[data-symbol="{{ quote.symbol }}"]');
            if (priceEl) {
                priceEl.textContent = '$' + data.price.toFixed(2);
                priceEl.classList.add('price-updated');
                setTimeout(() => priceEl.classList.remove('price-updated'), 500);
            }
            
            // Update change with proper formatting
            const changeEl = document.querySelector('.stock-change[data-symbol="{{ quote.symbol }}"]');
            if (changeEl) {
                const changeText = (data.change >= 0 ? '+$' : '-$') + Math.abs(data.change).toFixed(2);
                const changePercent = (data.change_percent >= 0 ? '+' : '') + data.change_percent.toFixed(2) + '%';
                changeEl.innerHTML = changeText + ' <small>(' + changePercent + ')</small>';
                
                changeEl.classList.remove('text-success', 'text-danger');
                changeEl.classList.add(data.change >= 0 ? 'text-success' : 'text-danger');
            }
        }
        
        // Call original function for other elements
        if (originalUpdateStockPrice) {
            originalUpdateStockPrice(data);
        }
    };
</script>

<!-- Add to Watchlist Modal -->
<div class="modal fade" id="addWatchlistModal" tabindex="-1" aria-labelledby="addWatchlistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/watchlist/add" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="addWatchlistModalLabel">Add {{ quote.symbol }} to Watchlist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="symbol" value="{{ quote.symbol }}">
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Why are you watching this stock?"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-star"></i> Add to Watchlist
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
