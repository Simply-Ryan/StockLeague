{% extends "layout.html" %}

{% block title %}Explore - StockLeague{% endblock %}

{% block main %}
<style>
    .explore-hero {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark, #0056b3));
        padding: 2rem;
        border-radius: 0.75rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .explore-hero h1 {
        color: white;
        margin-bottom: 0.5rem;
    }

    .explore-hero p {
        color: rgba(255,255,255,0.9);
        margin-bottom: 1.5rem;
    }

    .search-container {
        position: relative;
    }

    .search-input {
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .search-input::placeholder {
        color: #aaa;
    }

    .market-status {
        display: inline-block;
        background: var(--success-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 1rem;
    }

    .market-status.closed {
        background: var(--danger-color);
    }

    .index-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.25rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .index-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .index-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .index-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .movers-section {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    .movers-section > div {
        flex: 1;
    }

    .mover-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .mover-item {
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
        background: var(--card-bg);
        border-left: 4px solid var(--primary-color);
        transition: all 0.2s ease;
        display: grid;
        grid-template-columns: 1fr 85px;
        gap: 0.75rem;
        align-items: start;
    }

    .mover-item a {
        text-decoration: none;
        color: inherit;
        grid-column: 1;
        grid-row: 1 / span 2;
    }

    .mover-chart {
        width: 85px;
        height: 30px;
        grid-column: 2;
        grid-row: 1;
    }

    .mover-change {
        font-weight: 700;
        font-size: 0.85rem;
        text-align: center;
        grid-column: 2;
        grid-row: 2;
    }

    .mover-item:hover a {
        color: var(--primary-color);
    }

    .mover-item.gainer {
        border-left-color: var(--success-color);
    }

    .mover-item.loser {
        border-left-color: var(--danger-color);
    }

    .mover-symbol {
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .mover-name {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .mover-price {
        font-weight: 600;
    }

    .stock-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.25rem;
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .stock-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .stock-symbol {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stock-name {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .stock-price {
        font-size: 1.25rem;
        font-weight: 700;
        text-align: right;
    }

    .stock-change {
        font-size: 0.9rem;
        font-weight: 600;
        text-align: right;
        margin-top: 0.25rem;
    }

    .stock-chart {
        margin: 0.5rem 0;
        flex-grow: 1;
        height: 40px;
        min-height: 40px;
    }

    .stock-action {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .stock-action button {
        flex: 1;
        padding: 0.5rem;
        font-size: 0.85rem;
        border-radius: 0.4rem;
    }

    .volume-leaders {
        background: var(--card-bg);
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
    }

    .volume-item {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s ease;
    }

    .volume-item:last-child {
        border-bottom: none;
    }

    .volume-item:hover {
        background: rgba(0,0,0,0.02);
    }

    .volume-symbol {
        font-weight: 700;
        color: var(--text-primary);
        text-decoration: none;
        margin-bottom: 0.25rem;
    }

    .volume-symbol:hover {
        color: var(--primary-color);
    }

    .volume-meta {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: var(--primary-color);
    }

    @media (max-width: 768px) {
        .explore-hero {
            padding: 1.5rem;
        }

        .movers-section {
            grid-template-columns: 1fr;
        }

        .stock-card {
            margin-bottom: 1rem;
        }

        .mover-list {
            max-height: 400px;
            overflow-y: auto;
        }
    }
</style>

<!-- Hero Section with Search -->
<div class="explore-hero">
    <h1><i class="fas fa-compass"></i> Explore Markets</h1>
    <p>Discover stocks, track market trends, and find your next investment opportunity</p>
    
    <form action="/trade" method="get" class="search-container">
        <div class="input-group input-group-lg">
            <span class="input-group-text" style="background: transparent; border: none;"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control search-input" name="symbol" 
                   placeholder="Search by symbol or company name (e.g., AAPL, Apple)" required 
                   style="border: none;">
            <button class="btn btn-light" type="submit" style="border-radius: 0 0.5rem 0.5rem 0; font-weight: 600;">
                Search
            </button>
        </div>
    </form>
</div>

<div class="container-fluid">
    <!-- Market Summary Section -->
    <section class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title"><i class="fas fa-globe-americas"></i> Market Overview</h2>
            <span class="market-status">ðŸ“Š Market {{ market_trend|capitalize }}</span>
        </div>
        
        <div class="row g-3 mb-4">
            {% for idx in market_indices %}
            <div class="col-12 col-md-4">
                <div class="index-card {% if idx.change_percent >= 0 %}border-success{% else %}border-danger{% endif %}" style="border-left: 4px solid {% if idx.change_percent >= 0 %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div class="index-name">{{ idx.display_name }}</div>
                    <div class="index-price">{{ idx.price | usd }}</div>
                    <div class="d-flex justify-content-center align-items-center mt-3 mb-3">
                        <div id="spinner_index_{{ idx.symbol }}" class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
                        <canvas id="index_{{ idx.symbol }}" class="sparkline-canvas" width="180" height="50" style="display:none;"></canvas>
                    </div>
                    <div class="d-flex justify-content-around text-center">
                        <div>
                            <div class="small text-muted">Change</div>
                            <div class="small font-weight-bold {% if idx.change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ '%.2f'|format(idx.change) }}
                            </div>
                        </div>
                        <div>
                            <div class="small text-muted">Percent</div>
                            <div class="small font-weight-bold {% if idx.change_percent >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ '%.2f'|format(idx.change_percent) }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Market Movers Section -->
    <section class="mb-5">
        <h2 class="section-title"><i class="fas fa-fire"></i> Market Movers</h2>
        <div class="row">
            <!-- Top Gainers -->
            <div class="col-lg-4">
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: var(--text-primary); font-weight: 700; margin-bottom: 1rem;">
                        <i class="fas fa-arrow-up" style="color: var(--success-color); margin-right: 0.5rem;"></i>
                        Top Gainers
                    </h5>
                    <ul class="mover-list">
                        {% for s in market_movers.gainers %}
                        <li class="mover-item gainer">
                            <a href="/trade?symbol={{ s.symbol }}">
                                <div class="mover-symbol">{{ s.symbol }}</div>
                                <div class="mover-name">{{ s.name }}</div>
                                <div class="mover-price" style="margin-top: 0.5rem;">{{ s.price | usd }}</div>
                            </a>
                            <span class="mover-change text-success">+{{ '%.2f'|format(s.change_percent) }}%</span>
                            <div class="mover-chart">
                                <div id="spinner_mover_{{ s.symbol }}" class="spinner-border spinner-border-sm text-secondary" role="status" style="width: 0.75rem; height: 0.75rem;"></div>
                                <canvas id="mover_{{ s.symbol }}" class="sparkline-canvas" width="80" height="30" style="display:none; width:80px !important; height:30px !important;"></canvas>
                            </div>
                        </li>
                        {% else %}
                        <li class="text-muted text-center py-3">No gainers at this time</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Volume Leaders (Center) -->
            <div class="col-lg-4">
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: var(--text-primary); font-weight: 700; margin-bottom: 1rem;">
                        <i class="fas fa-volume-up" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                        Volume Leaders
                    </h5>
                    <div class="volume-leaders">
                        {% for v in volume_leaders[:6] %}
                        <div class="volume-item">
                            <a href="/trade?symbol={{ v.symbol }}" class="volume-symbol">
                                {{ v.symbol }}
                            </a>
                            <div class="volume-meta">
                                <span class="d-block">{{ v.price | usd }}</span>
                                <span class="d-block"><i class="fas fa-chart-bar"></i> Vol: {{ v.volume or 'N/A' }}</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="volume-item text-center text-muted py-4">
                            <p>No volume leaders at this time</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Top Losers -->
            <div class="col-lg-4">
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: var(--text-primary); font-weight: 700; margin-bottom: 1rem;">
                        <i class="fas fa-arrow-down" style="color: var(--danger-color); margin-right: 0.5rem;"></i>
                        Top Losers
                    </h5>
                    <ul class="mover-list">
                        {% for s in market_movers.losers %}
                        <li class="mover-item loser">
                            <a href="/trade?symbol={{ s.symbol }}">
                                <div class="mover-symbol">{{ s.symbol }}</div>
                                <div class="mover-name">{{ s.name }}</div>
                                <div class="mover-price" style="margin-top: 0.5rem;">{{ s.price | usd }}</div>
                            </a>
                            <span class="mover-change text-danger">{{ '%.2f'|format(s.change_percent) }}%</span>
                            <div class="mover-chart">
                                <div id="spinner_mover_{{ s.symbol }}" class="spinner-border spinner-border-sm text-secondary" role="status" style="width: 0.75rem; height: 0.75rem;"></div>
                                <canvas id="mover_{{ s.symbol }}" class="sparkline-canvas" width="80" height="30" style="display:none; width:80px !important; height:30px !important;"></canvas>
                            </div>
                        </li>
                        {% else %}
                        <li class="text-muted text-center py-3">No losers at this time</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Popular Stocks Section -->
    <section class="mb-5">
        <h2 class="section-title"><i class="fas fa-star"></i> Popular Stocks</h2>
        <div class="row g-3">
            {% for stock in popular_stocks %}
            <div class="col-12 col-md-6 col-lg-4">
                <div class="stock-card">
                    <div class="stock-header">
                        <div>
                            <div class="stock-symbol">{{ stock.symbol }}</div>
                            <div class="stock-name">{{ stock.name }}</div>
                        </div>
                        <div>
                            <div class="stock-price">{{ stock.price | usd }}</div>
                            <div class="stock-change {% if stock.change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if stock.change >= 0 %}â†‘{% else %}â†“{% endif %} {{ '%.2f'|format(stock.change_percent|abs) }}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="stock-chart">
                        <div id="spinner_stock_{{ stock.symbol }}" class="spinner-border spinner-border-sm text-secondary" role="status" style="width: 1rem; height: 1rem;"></div>
                        <canvas id="stock_{{ stock.symbol }}" class="sparkline-canvas" width="100%" height="40" style="display:none; width:100% !important;"></canvas>
                    </div>
                    
                    <div class="stock-action">
                        <a href="/trade?symbol={{ stock.symbol }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chart-line"></i> View
                        </a>
                        <button class="btn btn-outline-secondary btn-sm" onclick="addToWatchlist('{{ stock.symbol }}')">
                            <i class="fas fa-bookmark"></i> Watch
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12 text-center py-5 text-muted">
                <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="mt-3">No popular stocks available</p>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Volume Leaders Section (Moved to Market Movers) -->

</div>

<!-- Chart.js for sparklines (pinned version for reliability) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Load sparklines asynchronously via API to speed up initial page render
const popularSymbols = {{ popular_symbols | tojson | safe }} || [];
const indexSymbols = {{ index_symbols | tojson | safe }} || [];
const gainers = {{ market_movers.gainers|map(attribute='symbol')|list|tojson|safe }} || [];
const losers = {{ market_movers.losers|map(attribute='symbol')|list|tojson|safe }} || [];

function renderSparkline(canvasId, prices, allCandles){
    const el = document.getElementById(canvasId);
    const spinner = document.getElementById('spinner_' + canvasId);
    
    if(!el) {
        if(spinner) spinner.style.display = 'none';
        return;
    }
    
    try {
        // Use only the most recent candles (intraday/current day data)
        const recentPrices = (prices || []).slice(-100);
        const data = recentPrices.map(v => {
            const num = Number(v);
            return isNaN(num) ? 0 : num;
        }).filter(v => v > 0);
        
        if(!data || data.length < 2){
            console.warn('Not enough data for sparkline:', canvasId, data?.length || 0);
            if(spinner) spinner.style.display = 'none';
            return;
        }
        
        // Hide spinner and show canvas
        if(spinner) {
            spinner.style.display = 'none';
            spinner.style.visibility = 'hidden';
        }
        el.style.display = 'block';
        el.style.visibility = 'visible';
        
        // Calculate daily change from all available candles
        // Use opening price of first candle and closing price of last candle
        let dailyChangePercent = 0;
        if(allCandles && allCandles.length > 0) {
            // If we have candle data with open/close, calculate from that
            const firstCandle = allCandles[0];
            const lastCandle = allCandles[allCandles.length - 1];
            if(firstCandle.open && lastCandle.close) {
                dailyChangePercent = ((lastCandle.close - firstCandle.open) / firstCandle.open) * 100;
            }
        }
        
        // Determine color based on daily change
        const lineColor = dailyChangePercent >= 0 ? '#198754' : '#dc3545';
        
        // Create chart
        new Chart(el.getContext('2d'), {
            type: 'line',
            data: {
                labels: data.map((_, i) => i),
                datasets: [{
                    data: data,
                    borderColor: lineColor,
                    backgroundColor: 'rgba(0,0,0,0)',
                    pointRadius: 0,
                    borderWidth: 2,
                    fill: false,
                    tension: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                elements: {
                    line: { tension: 0 }
                },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
    } catch(e) {
        if(spinner) {
            spinner.style.display = 'none';
            spinner.style.visibility = 'hidden';
        }
        console.warn('renderSparkline error for ' + canvasId + ':', e.message);
    }
}

function fetchAndRender(symbol, prefix, retries = 0){
    const maxRetries = 2;
    // encode symbol for URL (caret ^ will be encoded)
    const urlSym = encodeURIComponent(symbol);
    const spinner = document.getElementById('spinner_' + prefix + symbol);
    
    // Set a timeout for the fetch request
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    
    fetch(`/api/chart/${urlSym}?days=1&timeframe=5`, {
        method: 'GET',
        signal: controller.signal
    })
    .then(r => {
        clearTimeout(timeoutId);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
    })
    .then(j=>{
        const canvasId = `${prefix}${symbol}`;
        // Extract closing prices from candles and pass full candles array
        const prices = (j.candles || []).map(c => c.close || c.price || 0);
        renderSparkline(canvasId, prices, j.candles);
    })
    .catch(e=>{
        clearTimeout(timeoutId);
        if(spinner) spinner.style.display = 'none';
        console.warn(`fetch spark error for ${symbol}:`, e.message);
        // Retry logic for failed requests
        if(retries < maxRetries) {
            setTimeout(() => fetchAndRender(symbol, prefix, retries + 1), 1000);
        }
    });
}

function addToWatchlist(symbol) {
    fetch('/api/watchlist/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({symbol: symbol})
    })
    .then(r => r.json())
    .then(data => {
        if(data.success) {
            // Show success toast
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Added!';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-secondary');
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        } else {
            alert('Failed to add to watchlist: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error adding to watchlist');
    });
}

// Kick off fetches
popularSymbols.forEach(sym => fetchAndRender(sym, 'stock_'));
indexSymbols.forEach(sym => fetchAndRender(sym, 'index_'));
gainers.forEach(sym => fetchAndRender(sym, 'mover_'));
losers.forEach(sym => fetchAndRender(sym, 'mover_'));
</script>

{% endblock %}
