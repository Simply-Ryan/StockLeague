<!-- League Activity Feed Component -->
<div class="card activity-feed-card">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-stream"></i> League Activity
        </h5>
        <button class="btn btn-sm btn-light" id="refresh-feed" title="Refresh feed">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
    
    <div class="card-body p-0" id="activity-feed-container" style="max-height: 600px; overflow-y: auto;">
        <!-- Activities will be loaded here -->
        <div class="text-center p-4">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading activity feed...</p>
        </div>
    </div>
    
    <div class="card-footer text-center">
        <button class="btn btn-sm btn-outline-secondary" id="load-more-btn" style="display: none;">
            Load More Activities
        </button>
    </div>
</div>

<!-- Activity Item Template -->
<template id="activity-item-template">
    <div class="activity-item border-bottom px-3 py-3" data-activity-id="">
        <div class="d-flex align-items-start">
            <!-- User Avatar -->
            <div class="me-3">
                <img src="" alt="user" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
            </div>
            
            <!-- Activity Content -->
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <div>
                        <strong class="activity-username"></strong>
                        <span class="activity-type-badge badge ms-2"></span>
                    </div>
                    <small class="text-muted activity-timestamp"></small>
                </div>
                
                <p class="activity-title mb-1"></p>
                <small class="text-muted activity-description d-block"></small>
                
                <!-- Activity-specific details -->
                <div class="activity-details mt-2 small"></div>
            </div>
        </div>
    </div>
</template>

<style>
    .activity-feed-card {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    #activity-feed-container {
        flex: 1;
        overflow-y: auto;
    }
    
    .activity-item {
        transition: background-color 0.2s ease;
    }
    
    .activity-item:hover {
        background-color: var(--bg-hover, rgba(0, 0, 0, 0.02));
    }
    
    .activity-item.new-activity {
        background-color: var(--primary-light, rgba(25, 118, 210, 0.1));
        animation: slideIn 0.4s ease;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(-20px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .activity-type-badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
        white-space: nowrap;
    }
    
    .activity-type-badge.trade {
        background-color: #17a2b8;
        color: white;
    }
    
    .activity-type-badge.achievement {
        background-color: #ffc107;
        color: black;
    }
    
    .activity-type-badge.ranking_change {
        background-color: #dc3545;
        color: white;
    }
    
    .activity-type-badge.ranking {
        background-color: #dc3545;
        color: white;
    }
    
    .activity-type-badge.joined {
        background-color: #28a745;
        color: white;
    }
    
    .activity-type-badge.milestone {
        background-color: #6f42c1;
        color: white;
    }
    
    .activity-type-badge.achievement_unlocked {
        background-color: #ffc107;
        color: black;
    }
    
    .activity-username {
        color: var(--text-primary, #333);
        font-size: 0.95rem;
        word-break: break-word;
    }
    
    .activity-title {
        color: var(--text-primary, #333);
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
        word-break: break-word;
    }
    
    .activity-description {
        color: var(--text-secondary, #666);
        word-break: break-word;
    }
    
    .activity-details {
        padding: 0.5rem 0.75rem;
        background-color: var(--bg-secondary, #f8f9fa);
        border-radius: 4px;
        color: var(--text-secondary, #666);
        word-break: break-word;
    }
    
    .activity-timestamp {
        font-size: 0.85rem;
        white-space: nowrap;
        margin-left: auto;
        padding-left: 0.5rem;
    }
    
    /* Theme-aware styling */
    :root[data-theme="dark"] .activity-item {
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }
    
    :root[data-theme="dark"] .activity-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    :root[data-theme="dark"] .activity-details {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .activity-feed-card {
            max-height: 400px;
        }
        
        #activity-feed-container {
            max-height: 350px;
        }
        
        .activity-item {
            padding: 0.5rem !important;
        }
        
        .activity-type-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
        }
        
        .activity-username {
            font-size: 0.9rem;
        }
        
        .activity-title {
            font-size: 0.9rem;
        }
        
        .activity-timestamp {
            font-size: 0.75rem;
        }
    }
    
    @media (max-width: 576px) {
        .activity-feed-card {
            max-height: 300px;
            margin-top: 1rem;
        }
        
        #activity-feed-container {
            max-height: 250px;
        }
        
        .activity-item {
            padding: 0.5rem !important;
        }
        
        .activity-item img {
            width: 32px !important;
            height: 32px !important;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const leagueId = {{ league_id | default('null') }};
    if (!leagueId) {
        console.error('League ID not provided to activity feed component');
        return;
    }
    
    let currentOffset = 0;
    const pageLimit = 20;
    let hasMore = true;
    
    // Load initial activities
    loadActivities();
    
    // Refresh button
    document.getElementById('refresh-feed').addEventListener('click', function() {
        currentOffset = 0;
        hasMore = true;
        loadActivities(true);
    });
    
    // Load more button
    document.getElementById('load-more-btn').addEventListener('click', function() {
        loadActivities(false);
    });
    
    function loadActivities(isRefresh = false) {
        const container = document.getElementById('activity-feed-container');
        const url = `/api/league/${leagueId}/activity-feed?limit=${pageLimit}&offset=${currentOffset}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const activities = data.activities || [];
                
                if (isRefresh) {
                    container.innerHTML = '';
                }
                
                if (activities.length === 0 && currentOffset === 0) {
                    container.innerHTML = `
                        <div class="text-center p-5">
                            <i class="fas fa-inbox" style="font-size: 3rem; color: var(--text-secondary, #999);"></i>
                            <p class="mt-3 text-muted">No activities yet. Start trading to see activity here!</p>
                        </div>
                    `;
                    return;
                }
                
                // Render activities
                activities.forEach(activity => {
                    renderActivity(activity, container);
                });
                
                // Update pagination
                currentOffset += activities.length;
                const loadMoreBtn = document.getElementById('load-more-btn');
                loadMoreBtn.style.display = data.has_more ? 'block' : 'none';
            })
            .catch(error => {
                console.error('Error loading activity feed:', error);
                container.innerHTML = `
                    <div class="text-center p-4 text-danger">
                        <i class="fas fa-exclamation-circle"></i> Failed to load activities
                    </div>
                `;
            });
    }
    
    function renderActivity(activity, container) {
        const template = document.getElementById('activity-item-template');
        const clone = template.content.cloneNode(true);
        
        // Get user avatar (use default if not available)
        const avatarUrl = activity.user_avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(activity.username || 'User')}&background=random`;
        
        // Populate template
        clone.querySelector('img').src = avatarUrl;
        clone.querySelector('.activity-username').textContent = activity.username || 'System';
        clone.querySelector('.activity-title').textContent = activity.title;
        clone.querySelector('.activity-description').textContent = activity.description;
        clone.querySelector('.activity-timestamp').textContent = getRelativeTime(activity.created_at);
        clone.querySelector('.activity-item').setAttribute('data-activity-id', activity.id);
        
        // Set type badge
        const typeBadge = clone.querySelector('.activity-type-badge');
        const activityType = activity.activity_type;
        typeBadge.textContent = activity.activity_type.charAt(0).toUpperCase() + activity.activity_type.slice(1);
        typeBadge.className = `activity-type-badge badge ${activityType}`;
        
        // Add type-specific details
        const detailsDiv = clone.querySelector('.activity-details');
        if (activity.metadata) {
            detailsDiv.innerHTML = renderActivityDetails(activity);
        } else {
            detailsDiv.style.display = 'none';
        }
        
        // Add to container
        container.appendChild(clone);
    }
    
    function renderActivityDetails(activity) {
        const meta = activity.metadata;
        let html = '';
        
        if (activity.activity_type === 'trade' && meta) {
            const tradeType = meta.type === 'buy' ? 'üìà BUY' : 'üìâ SELL';
            html = `
                <strong>${tradeType}</strong> ${meta.shares} shares of <strong>${meta.symbol}</strong>
                <br/>
                <small>
                    Price: <strong>$${parseFloat(meta.price).toFixed(2)}</strong>
                    | Total: <strong>$${parseFloat(meta.total).toFixed(2)}</strong>
                </small>
            `;
        } else if (activity.activity_type === 'achievement_unlocked' && meta) {
            html = `üèÜ <strong>${meta.achievement_name || 'Achievement'}</strong>`;
        } else if (activity.activity_type === 'ranking_change' && meta) {
            const arrow = meta.rank_change < 0 ? 'üìà' : 'üìâ';
            html = `${arrow} Rank changed by ${Math.abs(meta.rank_change)} positions`;
        } else if (activity.activity_type === 'joined' && meta) {
            html = `Starting cash: <strong>$${parseFloat(meta.starting_cash).toFixed(2)}</strong>`;
        } else if (activity.activity_type === 'milestone' && meta) {
            html = `üéâ <strong>${meta.milestone_name || 'Milestone'}</strong>`;
        }
        
        return html;
    }
    
    function getRelativeTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) {
            return 'Just now';
        } else if (diffMins < 60) {
            return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
        } else if (diffHours < 24) {
            return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        } else if (diffDays < 7) {
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        } else {
            return date.toLocaleDateString();
        }
    }
    
    // Real-time updates via Socket.IO (optional - only if socket is available)
    if (typeof socketio !== 'undefined' && typeof io !== 'undefined') {
        const socket = io();
        socket.on('league_activity_new', function(data) {
            if (data.league_id === leagueId) {
                // Add new activity to top of feed
                const container = document.getElementById('activity-feed-container');
                if (container.querySelector('.text-center')) {
                    // Empty state - reload instead
                    currentOffset = 0;
                    loadActivities(true);
                } else {
                    // Add to top with animation
                    const tempDiv = document.createElement('div');
                    renderActivity(data.activity, tempDiv);
                    const newItem = tempDiv.querySelector('.activity-item');
                    newItem.classList.add('new-activity');
                    container.insertBefore(newItem, container.firstChild);
                }
            }
        });
    }
});
</script>
