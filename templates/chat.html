{% extends "layout.html" %}
{% block title %}Chat Room - StockLeague{% endblock %}
{% block main %}
<div class="container py-4">
    <h2 class="mb-4"><i class="fas fa-comments"></i> Real-Time Chat</h2>
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-users"></i> Room: <span id="chat-room-name">General</span></span>
                    <span id="user-presence" class="badge bg-success">Online</span>
                </div>
                <div class="card-body p-0">
                    <div id="chat-history" class="p-3" style="height:350px; overflow-y:auto; background:#f8f9fa;"></div>
                    <div class="p-3 border-top">
                        <form id="chat-form" autocomplete="off">
                            <div class="input-group">
                                <input type="text" id="chat-input" class="form-control" placeholder="Type a message..." maxlength="500">
                                <button type="button" class="btn btn-light" id="emoji-btn"><i class="far fa-smile"></i></button>
                                <input type="file" id="file-input" style="display:none;">
                                <button type="button" class="btn btn-light" id="file-btn"><i class="fas fa-paperclip"></i></button>
                                <button type="submit" class="btn btn-primary">Send</button>
                            </div>
                            <div id="typing-indicator" class="mt-2 text-muted" style="display:none;">Someone is typing...</div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card shadow">
                <div class="card-body">
                    <h5>Rooms</h5>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="switchRoom('General')">General</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="switchRoom('Leagues')">Leagues</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="switchRoom('Trading')">Trading</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="switchRoom('Friends')">Friends</button>
                    </div>
                    <h5>Active Users</h5>
                    <ul id="active-users" class="list-unstyled mb-0"></ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Emoji Picker CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.6.2/dist/emoji-picker.min.css">
<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.6.2/dist/emoji-picker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.2/dist/socket.io.min.js"></script>
<script>
const socket = io();
let currentRoom = 'General';
let username = '{{ session["username"] if session["username"] else "User" }}';
// Join default room
socket.emit('join_room', { room: currentRoom, username });
// Message send
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const chatHistory = document.getElementById('chat-history');
const typingIndicator = document.getElementById('typing-indicator');
const emojiBtn = document.getElementById('emoji-btn');
const fileBtn = document.getElementById('file-btn');
const fileInput = document.getElementById('file-input');
const activeUsers = document.getElementById('active-users');
// Emoji picker
let picker;
emojiBtn.onclick = () => {
    if (!picker) {
        picker = document.createElement('emoji-picker');
        picker.style.position = 'absolute';
        picker.style.bottom = '60px';
        picker.style.left = '50%';
        picker.style.transform = 'translateX(-50%)';
        document.body.appendChild(picker);
        picker.addEventListener('emoji-click', e => {
            chatInput.value += e.detail.unicode;
            picker.remove();
            picker = null;
        });
    } else {
        picker.remove();
        picker = null;
    }
};
// File sharing
fileBtn.onclick = () => fileInput.click();
fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            socket.emit('chat_file', { room: currentRoom, username, filename: file.name, data: e.target.result });
        };
        reader.readAsDataURL(file);
    }
};
// Typing indicator
chatInput.oninput = () => {
    socket.emit('typing', { room: currentRoom, username });
};
socket.on('show_typing', data => {
    typingIndicator.style.display = 'block';
    setTimeout(() => typingIndicator.style.display = 'none', 2000);
});
// Message reactions
function addReaction(msgId, emoji) {
    socket.emit('add_reaction', { room: currentRoom, msgId, emoji });
}
// Send message
chatForm.onsubmit = e => {
    e.preventDefault();
    if (chatInput.value.trim()) {
        socket.emit('chat_message', { room: currentRoom, username, message: chatInput.value });
        chatInput.value = '';
    }
};
socket.on('chat_message', data => {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'mb-2';
    msgDiv.innerHTML = `<strong>${data.username}</strong>: ${data.message} <span class='text-muted small'>${data.time}</span>`;
    // Reaction button
    msgDiv.innerHTML += ` <button class='btn btn-sm btn-light' onclick="addReaction('${data.id}', 'üëç')">üëç</button>`;
    msgDiv.innerHTML += ` <button class='btn btn-sm btn-light' onclick="addReaction('${data.id}', 'üòÇ')">üòÇ</button>`;
    msgDiv.innerHTML += ` <button class='btn btn-sm btn-light' onclick="addReaction('${data.id}', 'üî•')">üî•</button>`;
    chatHistory.appendChild(msgDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
});
socket.on('chat_file', data => {
    const fileDiv = document.createElement('div');
    fileDiv.className = 'mb-2';
    fileDiv.innerHTML = `<strong>${data.username}</strong> shared a file: <a href='${data.data}' download='${data.filename}'>${data.filename}</a> <span class='text-muted small'>${data.time}</span>`;
    chatHistory.appendChild(fileDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
});
socket.on('add_reaction', data => {
    // Find message by id and append emoji
    // (For demo, just append to last message)
    if (chatHistory.lastChild) {
        chatHistory.lastChild.innerHTML += ` <span>${data.emoji}</span>`;
    }
});
socket.on('chat_history', messages => {
    chatHistory.innerHTML = '';
    messages.forEach(data => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'mb-2';
        msgDiv.innerHTML = `<strong>${data.username}</strong>: ${data.message} <span class='text-muted small'>${data.time}</span>`;
        chatHistory.appendChild(msgDiv);
    });
    chatHistory.scrollTop = chatHistory.scrollHeight;
});
socket.on('user_presence', users => {
    activeUsers.innerHTML = '';
    users.forEach(u => {
        const li = document.createElement('li');
        li.textContent = u;
        activeUsers.appendChild(li);
    });
});
function switchRoom(room) {
    currentRoom = room;
    document.getElementById('chat-room-name').textContent = room;
    socket.emit('join_room', { room, username });
}
</script>
{% endblock %}
