{% extends "layout.html" %}

{% block title %}
    Options Chain - {{ symbol }}
{% endblock %}

{% block main %}
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="bi bi-grid-3x3-gap me-2"></i>Options Chain</h2>
                        <h3 class="text-primary">{{ symbol }}</h3>
                    </div>
                    <div class="text-end">
                        <h5>Current Price</h5>
                        <h3 class="mb-0 {% if quote.change >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ "%.2f"|format(current_price) }}
                        </h3>
                        <small class="{% if quote.change >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.2f"|format(quote.change) }} ({{ "%.2f"|format(quote.change_percent) }}%)
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expiration Date Selector -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" action="/options/chain/{{ symbol }}" class="row g-3">
                    <div class="col-md-6">
                        <label for="expiration" class="form-label">Expiration Date</label>
                        <select class="form-select" id="expiration" name="expiration" onchange="this.form.submit()">
                            {% for date in expiration_dates %}
                                <option value="{{ date }}" {% if date == selected_expiration %}selected{% endif %}>
                                    {{ date }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <a href="/options" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Back to Positions
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Options Chain Table -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Options Chain - Expiration: {{ selected_expiration }}</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th colspan="7" class="text-center bg-success text-white">CALLS</th>
                                <th class="text-center bg-dark text-white">STRIKE</th>
                                <th colspan="7" class="text-center bg-danger text-white">PUTS</th>
                            </tr>
                            <tr>
                                <th>Delta</th>
                                <th>Gamma</th>
                                <th>Theta</th>
                                <th>Bid</th>
                                <th>Ask</th>
                                <th>Volume</th>
                                <th>Action</th>
                                <th class="text-center">Strike</th>
                                <th>Action</th>
                                <th>Volume</th>
                                <th>Bid</th>
                                <th>Ask</th>
                                <th>Theta</th>
                                <th>Gamma</th>
                                <th>Delta</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(chain.calls|length) %}
                                {% set call = chain.calls[i] %}
                                {% set put = chain.puts[i] %}
                                <tr class="{% if call.strike == (current_price|round|int) %}table-warning{% endif %}">
                                    <!-- CALL DATA -->
                                    <td><span class="badge bg-secondary">{{ "%.3f"|format(call.delta) }}</span></td>
                                    <td><small>{{ "%.4f"|format(call.gamma) }}</small></td>
                                    <td><small>{{ "%.3f"|format(call.theta) }}</small></td>
                                    <td>${{ "%.2f"|format(call.bid) }}</td>
                                    <td>${{ "%.2f"|format(call.ask) }}</td>
                                    <td><small class="text-muted">{{ call.volume }}</small></td>
                                    <td>
                                        <button class="btn btn-sm btn-success" 
                                                onclick="buyOption({{ call.contract_id }}, '{{ symbol }}', 'call', {{ call.strike }}, '{{ selected_expiration }}', {{ call.ask }})">
                                            <i class="bi bi-cart-plus"></i>
                                        </button>
                                    </td>
                                    
                                    <!-- STRIKE PRICE -->
                                    <td class="text-center fw-bold">
                                        ${{ "%.2f"|format(call.strike) }}
                                        {% if call.in_the_money %}<i class="bi bi-check-circle-fill text-success"></i>{% endif %}
                                    </td>
                                    
                                    <!-- PUT DATA -->
                                    <td>
                                        <button class="btn btn-sm btn-danger" 
                                                onclick="buyOption({{ put.contract_id }}, '{{ symbol }}', 'put', {{ put.strike }}, '{{ selected_expiration }}', {{ put.ask }})">
                                            <i class="bi bi-cart-plus"></i>
                                        </button>
                                    </td>
                                    <td><small class="text-muted">{{ put.volume }}</small></td>
                                    <td>${{ "%.2f"|format(put.bid) }}</td>
                                    <td>${{ "%.2f"|format(put.ask) }}</td>
                                    <td><small>{{ "%.3f"|format(put.theta) }}</small></td>
                                    <td><small>{{ "%.4f"|format(put.gamma) }}</small></td>
                                    <td><span class="badge bg-secondary">{{ "%.3f"|format(put.delta) }}</span></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Greeks Explanation -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Understanding the Greeks</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6><strong>Delta (Δ)</strong></h6>
                        <p class="small">Rate of change in option price per $1 move in stock. Range: 0 to 1 (calls), 0 to -1 (puts)</p>
                    </div>
                    <div class="col-md-3">
                        <h6><strong>Gamma (Γ)</strong></h6>
                        <p class="small">Rate of change in delta per $1 move in stock. Highest for ATM options.</p>
                    </div>
                    <div class="col-md-3">
                        <h6><strong>Theta (Θ)</strong></h6>
                        <p class="small">Time decay - how much option loses per day. Always negative for long positions.</p>
                    </div>
                    <div class="col-md-3">
                        <h6><strong>Vega (ν)</strong></h6>
                        <p class="small">Sensitivity to volatility changes. Higher vega means more sensitive to IV changes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buy Option Modal -->
    <div class="modal fade" id="buyOptionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buy Option Contract</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/options/buy" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="contract_id" id="buy_contract_id">
                        <input type="hidden" name="premium" id="buy_premium">
                        
                        <div class="alert alert-info" id="buy_option_info"></div>
                        
                        <div class="mb-3">
                            <label for="buy_contracts" class="form-label">Number of Contracts</label>
                            <input type="number" class="form-control" id="buy_contracts" name="contracts" 
                                   min="1" value="1" required>
                            <small class="text-muted">Each contract represents 100 shares</small>
                        </div>
                        
                        <div class="alert alert-warning">
                            <strong>Total Cost:</strong> $<span id="total_cost">0.00</span>
                            <br><small class="text-muted">(Premium × Contracts × 100)</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-cart-check me-2"></i>Buy Options
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function buyOption(contractId, symbol, optionType, strike, expiration, premium) {
            document.getElementById('buy_contract_id').value = contractId;
            document.getElementById('buy_premium').value = premium;
            document.getElementById('buy_contracts').value = 1;
            
            const badge = optionType === 'call' ? 
                '<span class="badge bg-success">CALL</span>' : 
                '<span class="badge bg-danger">PUT</span>';
            
            document.getElementById('buy_option_info').innerHTML = 
                `<strong>${symbol}</strong> ${badge} $${strike.toFixed(2)} exp ${expiration}<br>` +
                `Premium: $${premium.toFixed(2)} per share`;
            
            updateTotalCost();
            
            // Update cost on contract change
            document.getElementById('buy_contracts').oninput = updateTotalCost;
            
            new bootstrap.Modal(document.getElementById('buyOptionModal')).show();
        }
        
        function updateTotalCost() {
            const contracts = parseFloat(document.getElementById('buy_contracts').value) || 0;
            const premium = parseFloat(document.getElementById('buy_premium').value) || 0;
            const cost = contracts * premium * 100;
            document.getElementById('total_cost').textContent = cost.toFixed(2);
        }
    </script>
{% endblock %}
